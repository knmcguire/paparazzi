<!DOCTYPE flight_plan SYSTEM "../../flight_plan.dtd">

<procedure>
  <blocks>
<!--VERSION 4-->
<!-- Turn based on a desired heading-->

  <block name="Start">

         <deroute block="Go_Forward"/>
  </block>

  <block name="Go_Forward">
        <call_once fun="autopilot_guided_update(GUIDED_FLAG_XY_VEL_BODY_YAW_RATE,0,0,-nominal_alt,0)"/>
      <while cond="LessThan(stage_time,1)"/> 

      <while cond="1">
        <call_once fun="autopilot_guided_update(GUIDED_FLAG_XY_VEL_BODY_YAW_RATE,forward_vel,vel_body_y_FF_stereo,-nominal_alt,0)"/>
         <set var="save_distance" value="distance_obstacle_FP"/>
         <set var="x_offset_collision" value="tanf(heading_obstacle_FP)*distance_obstacle_FP"/>
      </while>
      <exception cond="save_offset>fabs(x_offset_collision)&&obstacle_distance_threshold>distance_obstacle_FP" deroute="Hover_before_Turning"/> 
    </block>

   <block name="Hover_before_Turning">
      <set var="counter" value="0"/>
      <call_once fun="autopilot_guided_update(GUIDED_FLAG_XY_VEL_BODY_YAW_OFFSET,0.,0.,-nominal_alt,DegOfRad(0))"/>
         <set var="diff_heading" value="stateGetNedToBodyEulers_f()->psi-desired_heading"/>
         <call_once fun="FLOAT_ANGLE_NORMALIZE(diff_heading)"/>
       <while cond="30 > counter">
         <set var="counter" value="counter+1"/>
       </while>
       <while cond="diff_heading>=0">
         <deroute block="Turn_Left"/>
       </while>
       <while cond="0>diff_heading">
         <deroute block="Turn_Right"/>
       </while>
   </block>

   <block name="Turn_Left">
        <set var="x_offset_collision" value="tanf(heading_obstacle_FP)*distance_obstacle_FP"/>
      <while cond ="save_offset>fabs(x_offset_collision)">
        <call_once fun="autopilot_guided_update(GUIDED_FLAG_XY_VEL_BODY_YAW_RATE,0,0,-nominal_alt,-0.3)"/>
        <set var="x_offset_collision" value="tanf(heading_obstacle_FP)*distance_obstacle_FP"/>
      </while>
      <deroute block="Go_Forward"/>
    </block>

   <block name="Turn_Right">
        <set var="x_offset_collision" value="tanf(heading_obstacle_FP)*distance_obstacle_FP"/>
      <while cond ="save_offset>fabs(x_offset_collision)">
        <call_once fun="autopilot_guided_update(GUIDED_FLAG_XY_VEL_BODY_YAW_RATE,0,0,-nominal_alt,0.3)"/>
        <set var="x_offset_collision" value="tanf(heading_obstacle_FP)*distance_obstacle_FP"/>
      </while>
      <deroute block="Go_Forward"/>
    </block>

   <!--block name="Go Past Obstacle">
      <set var="current_distance" value="stateGetPositionBody_f()->x"/>
      <set var="counter" value="0"/>
      <set var="counter" value="0"/>
       <while cond="turned_right&&70 > counter">
      <call_once fun="autopilot_guided_update(GUIDED_FLAG_XY_OFFSET_BODY_YAW_RATE,save_distance+0.3,0.2,-nominal_alt,0)"/>
      <call_once fun="counter++"/>
       </while>

      <while cond ="save_distance>diff_distance">
      <call_once fun="autopilot_guided_update(GUIDED_FLAG_XY_OFFSET_BODY_YAW_RATE,0,0,-nominal_alt,0)"/>
      <deroute block="Go_Forward"/>
    </block-->



  </blocks>
</procedure>
